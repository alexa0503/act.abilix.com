var image="",x=0,y=0,scale=1;$().ready(function(){function a(a){return a*r}var e=$("#custom-album img"),t=new Hammer.Manager($("#custom-album")[0]),o=new Hammer.Pan,n=new Hammer.Pinch;n.recognizeWith([o]),t.add(o),t.add(n);var i=0,l=0,c=0,s=0,d=1,r=1,u=e.width()||0,h=e.height()||0,m=$("#custom-album").width(),f=$("#custom-album").height(),p=1;wx.ready(function(){$(".btn-camera,.btn-album").on("touchend",function(){var a;if("camera"==$(this).attr("id")){var e=["camera"];_czc.push(["_trackEvent","abilix-H5","bt-拍摄造型"])}else{var e=["album"];_czc.push(["_trackEvent","abilix-H5","bt-相册选取"])}wx.chooseImage({count:1,sizeType:["compressed"],sourceType:e,success:function(e){a=e.localIds,setTimeout(function(){wx.uploadImage({localId:a[0],isShowProgressTips:2,success:function(a){var e=a.serverId,t="/image/"+e;$.ajax({url:t,dataType:"json",method:"GET"}).done(function(a){if(0==a.ret){u=a.data.width,h=a.data.height;var e=parseFloat(480/u),t=parseFloat(480/h);p=e<t?t.toFixed(1):e.toFixed(1),r=1,d=1,i=0,l=0,c=0,s=0,$("#upload-image").width(a.data.width),$("#upload-image").height(a.data.height),$("#upload-image").attr("src",a.data.url),image=a.data.path,$(".page").addClass("hide"),$("#page2").removeClass("hide")}}).fail(function(a,e,t){alert("上传失败，请稍候重试")}).always(function(){})}})},100)}})})}),t.on("panmove",function(a){var t=i+a.deltaX,o=l+a.deltaY;$.Velocity.hook(e,"translateX",t+"px"),$.Velocity.hook(e,"translateY",o+"px")}),t.on("panend",function(a){i+=a.deltaX,l+=a.deltaY;var t=e.offset(),o=t.left,n=t.top,p=$("#custom-album").offset(),g=p.left-4,v=p.top-4,b=p.left+m-d*u+4,w=p.top+f-d*h+4;c=o<b?b:o>g?g:o,s=n<w?w:n>v?v:n,e.offset({left:c,top:s}),scale=r,x=-1*(c-p.left+4),y=-1*(s-p.top+4)}),t.on("pinchmove",function(t){var o=a(t.scale);o>1&&(o=1),o<p&&(o=p),$.Velocity.hook(e,"scale",r)}),t.on("pinchend",function(t){r=a(t.scale),r>1&&(r=1),r<p&&(r=p),d=r,$.Velocity.hook(e,"scale",r);var o=e.offset(),n=o.left,i=o.top,l=$("#custom-album").offset(),g=l.left-4,v=l.top-4,b=l.left+m-d*u+4,w=l.top+f-d*h+4;c=n<b?b:n>g?g:n,s=i<w?w:i>v?v:i,e.offset({left:c,top:s}),scale=r,x=-1*(c-l.left+4),y=-1*(s-l.top+4)}),$(".btn-upload").on("touchend",function(){var a=$('input[name="name"]').val();hasSubmitted||(""===a?alert("作品名不能为空哦"):(_czc.push(["_trackEvent","abilix-H5","bt-作品上传"]),$.ajax({url:"/upload",data:{name:a,image:image,x:x,y:y,scale:scale,_token:window.Laravel.csrfToken},dataType:"json",method:"POST"}).done(function(a){0==a.ret?($(".page").addClass("hide"),$("#page3").removeClass("hide"),wxData.link=a.data.share_url,wxShare(wxData)):alert(a.msg)}).fail(function(a,e,t){alert("上传失败，请稍候重试")}).always(function(){})))}),$(".btn-reset").on("click",function(){_czc.push(["_trackEvent","abilix-H5","bt-重新上传"]),$(".page").addClass("hide"),$("#page1").removeClass("hide")}),$(".btn-share").on("touchend",function(){_czc.push(["_trackEvent","abilix-H5","bt-立刻分享"]),$("#modal-share").modal({keyboard:!1,show:!0})}),$(".share-close").on("touchend",function(){$("#modal-share").modal("hide")})});